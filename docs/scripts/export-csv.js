(()=>{"use strict";const e="https://chunithm-net-eng.com";var t,n;(n=t||(t={})).basic="BAS",n.advanced="ADV",n.expert="EXP",n.master="MAS",n.ultima="ULT";const o=Object.values(t);var r;!function(e){e["P & A"]="0",e.niconico="2",e["東方Project"]="3",e.ORIGINAL="5",e.VARIETY="6",e["イロドリ"]="7",e["ゲキマイ"]="9"}(r||(r={})),Object.keys(r);const a=Object.fromEntries(Object.entries(r).map((([e,t])=>[Number(t),e])));function c(e){const t=Array.from(document.querySelectorAll("script"));for(;t.length;){const n=t.pop();if(n?.src.includes(e)){const e=new URL(n.src),t=e.pathname;return e.origin+t.substring(0,t.lastIndexOf("/scripts"))}}return"https://dogeon188.github.io/chuni-tools"}function s(e){const t=document.cookie.split(";").map((e=>decodeURIComponent(e.trim()))).map((e=>e.split("="))).find((t=>t[0]===e));return t?t[1]:""}async function i(n=t.master){const o=new FormData;o.append("genre","99"),o.append("token",s("_t"));const r={[t.ultima]:"sendUltima",[t.master]:"sendMaster",[t.expert]:"sendExpert",[t.advanced]:"sendAdvanced",[t.basic]:"sendBasic"}[n],a=await async function(t,n){const o=await fetch(e+t,{headers:{"Cache-Control":"no-cache"},method:n?"POST":"GET",body:n});if(503===o.status||405===o.status)throw new Error("Service temporarily unavailable");if(-1!=o.url.indexOf("/error"))throw new Error("Request failed: rejected by server");return(new DOMParser).parseFromString(await o.text(),"text/html")}("/mobile/record/musicGenre/"+r,o);return Array.from(a.querySelectorAll(".box01.w420")[1].querySelectorAll("form")).map((e=>{const t=e.querySelector(".play_musicdata_icon"),o=e.querySelector(".text_b")?.innerHTML;return{title:e.querySelector(".music_title")?.innerHTML,score:o?(r=o,Number([...r].filter((e=>","!==e)).join(""))):-1,difficulty:n,clear:t?.querySelector('img[src*="alljustice"]')?"AJ":t?.querySelector('img[src*="fullcombo"]')?"FC":"",idx:e.querySelector('input[name="idx"]').value};var r})).filter((e=>e.title&&e.score))}var l;!function(e){e.en_US="en_US",e.zh_TW="zh_TW"}(l||(l={}));const d=[[101e4,"MAX"],[1009e3,"SSS+"],[1007500,"SSS"],[1005e3,"SS+"],[1e6,"SS"],[99e4,"S+"],[975e3,"S"],[95e4,"AAA"],[925e3,"AA"],[9e5,"A"],[8e5,"BBB"],[7e5,"BB"],[6e5,"B"],[5e5,"C"],[0,"D"]];function u(e){let t=0;return d.some(((n,o)=>(t=o,e>=n[0]))),d[t][1]}const f=[{score:1009e3,base:21500,ratio:0},{score:1007500,base:2e4,ratio:1},{score:1005e3,base:15e3,ratio:2},{score:1e6,base:1e4,ratio:1},{score:975e3,base:0,ratio:.4},{score:9e5,base:-5e4,ratio:2/3}];function p(e){return 5*(e.const+3)*1e4}const m=(e,t)=>e.score<0?1:t.score<0?-1:t.rating-e.rating||t.const-e.const||e.score-t.score;function g(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'")}!async function(t){const n={[l.en_US]:{pleaseLogin:"Please login to CHUNITHM-NET first.",needReload:"Oops! Something went wrong, please reload CHUNITHM-NET.",downloadCSV:"Download Song Record as CSV",downloading:"Downloading {{diff}} data...",downloaded:"Completed!"},[l.zh_TW]:{pleaseLogin:"請先登入 CHUNITHM-NET 再執行本程式。",needReload:"唉呀，看來我們這裡出了一點小意外，請重新整理 CHUNITHM-NET。",downloadCSV:"以CSV下載歌曲記錄",downloading:"正在下載 {{diff}} 資料...",downloaded:"下載完成！"}}[function(){const e=new URLSearchParams(location.search);return e.get("lang")?e.get("lang").startsWith("zh")?l.zh_TW:l.en_US:function(){switch(localStorage.getItem("language")){case l.en_US:return l.en_US;case l.zh_TW:return l.zh_TW}return null}()||(navigator.language.startsWith("zh")?l.zh_TW:l.en_US)}()];if(!s("_t"))return alert(n.pleaseLogin),void(window.location.href=e);try{const e=function(){const e=t.createElement("button");e.className="chuni-tool-btn";const o=t.createElement("link");return o.rel="stylesheet",o.href=c("export-csv")+"/common/styles/inject.css",e.innerText=n.downloadCSV,t.getElementsByTagName("head")[0].appendChild(o),o.addEventListener("load",(()=>{t.querySelector(".clearfix")?.insertAdjacentElement("afterend",e)})),e}();e.addEventListener("click",(async()=>{const r=[];for(const t of o){e.innerText=n.downloading.replace("{{diff}}",t);const o=(await i(t)).filter((e=>e.score>=0));Array.prototype.push.apply(r,o)}const s=function(e,t,n){const o=e,r=t,c=[];if(o.map((e=>{void 0===r[e.title]&&(e.title=g(e.title));let t=r[e.title];if(void 0===t)c.push(e),e.const=-1,e.rating=0;else{if("WE"===e.difficulty)return e.title=g(e.title),e.const=-1,e.rating=0,e.op=-1,e.opMax=-1,e.opPercent=-1,e.rank=u(e.score),e.genre=a[t.genre],void(e.version=t.version);e.const=t[e.difficulty],t.uncertain?.includes(e.difficulty)&&(e.constUncertain=!0),e.rawRating=function(e){let t,n=Math.floor(1e4*e.const);if(e.score>=9e5){let t=f.find((t=>e.score>=t.score));return Math.max(0,n+t.base+t.ratio*(e.score-t.score))}if(e.score>=8e5)t=(n-5e4)/2+(n-5e4)/2*(e.score-8e5)/1e5;else{if(!(e.score>=5e5))return 0;t=(n-5e4)/2*(e.score-5e5)/3e5}return Math.max(0,t)}(e),e.genre=`${t.genre}`,e.rating=Math.floor(e.rawRating/100),e.version=t.version}e.op=function(e){if(e.score>=101e4)return p(e);let t={AJ:2e3,FC:1e3,"":0}[e.clear],n=Math.floor(1e4*e.const),o=e.score<1007500?e.rawRating:n+2e4+3*(e.score-1007500);return o=e.score>=975e3?10*Math.floor(o/10):100*Math.floor(o/100),5*(o+t)}(e),e.opMax=p(e),e.opPercent=100*e.op/e.opMax,e.rank=u(e.score)})),n&&c.length){const e={};c.forEach((t=>{var n;e[n=t.title]??(e[n]=[]),e[t.title].push(t.difficulty)})),console.log(e),alert(n.replace("{{songs}}",Object.entries(e).map((([e,t])=>`    ${e} ${t.join(",")}`)).join("\n")))}return o.sort(m),o.map(((e,t)=>{e.order=t+1})),o}(r,await fetch(c("export-csv")+"/data/song-const/verse.json").then((async e=>await e.json()))),l=s.map((e=>`"${e.title.replace(/"/g,'""')}",${e.difficulty},${e.const},${e.score},${e.rating},${e.op}`));e.innerText=n.downloaded;const d=document.createElement("a");d.href="data:text/plain;charset=utf-8,"+encodeURIComponent("title,difficulty,const,score,rating,op\n"+l.join("\n")),d.target="_blank",d.download=`chunithm_record_${(new Date).toISOString()}.csv`,d.style.display="none",t.body.appendChild(d),d.click(),t.body.removeChild(d),setTimeout((()=>{e.innerText=n.downloadCSV}),3e3)}))}catch(e){alert(n.needReload),console.log(e)}}(document)})();