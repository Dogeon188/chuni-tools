(()=>{"use strict";var e;function t(e){const t=Array.from(document.querySelectorAll("script"));for(;t.length;){const o=t.pop();if(o?.src.includes(e)){const e=new URL(o.src),t=e.pathname;return e.origin+t.substring(0,t.lastIndexOf("/scripts"))}}return"https://dogeon188.github.io/chuni-tools"}function o(e){const t=document.cookie.split(";").map((e=>decodeURIComponent(e.trim()))).map((e=>e.split("="))).find((t=>t[0]===e));return t?t[1]:""}!function(e){e.en_US="en_US",e.zh_TW="zh_TW"}(e||(e={}));const r="https://chunithm-net-eng.com";var n,a;(a=n||(n={})).basic="BAS",a.advanced="ADV",a.expert="EXP",a.master="MAS",a.ultima="ULT";const c=Object.values(n);var i;!function(e){e["P & A"]="0",e.niconico="2",e["東方Project"]="3",e.ORIGINAL="5",e.VARIETY="6",e["イロドリ"]="7",e["ゲキマイ"]="9"}(i||(i={})),Object.keys(i);const s="99";async function l(e=n.master){const t=new FormData;t.append("genre",s),t.append("token",o("_t"));const a={[n.ultima]:"sendUltima",[n.master]:"sendMaster",[n.expert]:"sendExpert",[n.advanced]:"sendAdvanced",[n.basic]:"sendBasic"}[e],c=await async function(e,t){const o=await fetch(r+e,{headers:{"Cache-Control":"no-cache"},method:t?"POST":"GET",body:t});if(503===o.status||405===o.status)throw new Error("Service temporarily unavailable");if(-1!=o.url.indexOf("/error"))throw new Error("Request failed: rejected by server");return(new DOMParser).parseFromString(await o.text(),"text/html")}("/mobile/record/musicGenre/"+a,t);return Array.from(c.querySelectorAll(".box01.w420")[1].querySelectorAll("form")).map((t=>{const o=t.querySelector(".play_musicdata_icon"),r=t.querySelector(".text_b")?.innerHTML;return{title:t.querySelector(".music_title")?.innerHTML,score:r?(n=r,Number([...n].filter((e=>","!==e)).join(""))):-1,difficulty:e,clear:o?.querySelector('img[src*="alljustice"]')?"AJ":o?.querySelector('img[src*="fullcombo"]')?"FC":"",idx:t.querySelector('input[name="idx"]').value};var n})).filter((e=>e.title&&e.score))}const d=[[101e4,"MAX"],[1009e3,"SSS+"],[1007500,"SSS"],[1005e3,"SS+"],[1e6,"SS"],[99e4,"S+"],[975e3,"S"],[95e4,"AAA"],[925e3,"AA"],[9e5,"A"],[8e5,"BBB"],[7e5,"BB"],[6e5,"B"],[5e5,"C"],[0,"D"]];function u(e){let t=0;return d.some(((o,r)=>(t=r,e>=o[0]))),d[t][1]}const p=[[101e4,215],[1009e3,215],[1007500,200],[1005e3,150],[1e6,100],[975e3,0],[925e3,-300],[9e5,-500]],f={default:(e,t)=>e.score<0?1:t.score<0?-1:t.rating-e.rating||t.const-e.const||e.score-t.score,playOrder:(e,t)=>t.timestamp-e.timestamp,title:(e,t)=>e.title<t.title?-1:e.title>t.title?1:c.indexOf(t.difficulty)-c.indexOf(e.difficulty),const:(e,t)=>t.const-e.const||e.order-t.order,op:(e,t)=>t.op-e.op||e.order-t.order,opp:(e,t)=>t.op/t.opMax-e.op/e.opMax||e.order-t.order,score:(e,t)=>t.score-e.score||e.order-t.order,scoreDiff:(e,t)=>t.scoreDiff-e.scoreDiff||e.order-t.order,rating:(e,t)=>e.order-t.order,aj:(e,t)=>{if(e.clear==t.clear)return e.order-t.order;const o=["","FC","AJ"];return o.indexOf(t.clear)-o.indexOf(e.clear)},playcount:(e,t)=>null==e.playCount?100:null==t.playCount?-100:e.playCount==t.playCount?e.order-t.order:t.playCount-e.playCount};!async function(n){const a={[e.en_US]:{pleaseLogin:"Please login to CHUNITHM-NET first.",needReload:"Oops! Something went wrong, please reload CHUNITHM-NET.",downloadCSV:"Download Song Record as CSV",downloading:"Downloading {{diff}} data...",downloaded:"Completed!"},[e.zh_TW]:{pleaseLogin:"請先登入 CHUNITHM-NET 再執行本程式。",needReload:"唉呀，看來我們這裡出了一點小意外，請重新整理 CHUNITHM-NET。",downloadCSV:"以CSV下載歌曲記錄",downloading:"正在下載 {{diff}} 資料...",downloaded:"下載完成！"}}[function(){const t=new URLSearchParams(location.search);return t.get("lang")?t.get("lang").startsWith("zh")?e.zh_TW:e.en_US:function(){switch(localStorage.getItem("language")){case e.en_US:return e.en_US;case e.zh_TW:return e.zh_TW}return null}()||(navigator.language.startsWith("zh")?e.zh_TW:e.en_US)}()];if(!o("_t"))return alert(a.pleaseLogin),void(window.location.href=r);try{const e=function(){const e=n.createElement("button");e.className="chuni-tool-btn";const o=n.createElement("link");return o.rel="stylesheet",o.href=t("export-csv")+"/common/styles/inject.css",e.innerText=a.downloadCSV,n.getElementsByTagName("head")[0].appendChild(o),o.addEventListener("load",(()=>{n.querySelector(".clearfix")?.insertAdjacentElement("afterend",e)})),e}();e.addEventListener("click",(async()=>{const o=[];for(const t of c){e.innerText=a.downloading.replace("{{diff}}",t);const r=(await l(t)).filter((e=>e.score>=0));Array.prototype.push.apply(o,r)}const r=function(e,t,o){const r=e,n=t,a=[];return r.map((e=>{if("WE"===e.difficulty)return e.const=-1,e.rating=0,e.op=-1,e.opMax=-1,e.opPercent=-1,void(e.rank=u(e.score));void 0===n[e.title]&&(e.title=e.title.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"));let t=n[e.title];void 0===t?(a.push(e),e.const=-1,e.rating=0):(e.const=t[e.difficulty],e.rawRating=function(e){if(e.score<=5e5)return 0;let t,o=100*e.const;if(e.score<=8e5)t=(e.score-5e5)/3e5*((o-500)/2);else if(e.score<=9e5)t=(e.score-8e5)/1e5*((o-500)/2)+(o-500)/2;else{let r=1;p.some(((t,o)=>(r=o,e.score>t[0])));const n=p[r-1],a=p[r];t=o+a[1]+(n[1]-a[1])*(e.score-a[0])/(n[0]-a[0])}return Math.max(0,t)}(e),e.genre=`${t.genre}`,e.rating=Math.floor(e.rawRating)/100),e.op=function(e){let t={AJ:1e4,FC:5e3,"":0}[e.clear],o=0,r=Math.floor(parseFloat((1e4*e.const).toFixed()));return o=101e4==e.score?r+3e3:e.score>=1007500?r+2e4+3*(e.score-1007500):e.score>=1005e3?r+15e3+2*(e.score-1005e3):e.score>=1e6?r+1e4+1*(e.score-1e6):e.score>=975e3?r+.4*(e.score-975e3):100*e.rawRating,Math.floor(5*Math.floor(o/10)+(101e4==e.score?0:t/10))}(e),e.opMax=5*(e.const+3)*1e3,e.opPercent=100*e.op/e.opMax,e.rank=u(e.score)})),o&&a.length&&alert(o.replace("{{songs}}",a.map((e=>`    ${e.title} ${e.difficulty}`)).join("\n"))),r.sort(f.default),r.map(((e,t)=>{e.order=t+1})),r}(o,await fetch(t("export-csv")+"/data/song-const/intl.json").then((async e=>await e.json()))),i=r.map((e=>`"${e.title.replace(/"/g,'""')}",${e.difficulty},${e.const},${e.score},${e.rating},${e.op}`));e.innerText=a.downloaded;const s=document.createElement("a");s.href="data:text/plain;charset=utf-8,"+encodeURIComponent("title,difficulty,const,score,rating\n"+i.join("\n")),s.target="_blank",s.download=`chunithm_record_${(new Date).toISOString()}.csv`,s.style.display="none",n.body.appendChild(s),s.click(),n.body.removeChild(s),setTimeout((()=>{e.innerText=a.downloadCSV}),3e3)}))}catch(e){alert(a.needReload),console.log(e)}}(document)})();